#cloud-config

bootcmd:
  - echo <%= options['hostname'] %> > /etc/hostname
  - hostname -F /etc/hostname

hostname: <%= options['hostname'] %>
fqdn: <%= options['hostname'] %>
manage_etc_hosts: true

package_upgrade: true
package_reboot_if_required: true

write_files:
<% if options['puppet_repo']['csr_attributes'] %>
  - content: |
      ---
      custom_attributes:
        1.2.840.113549.1.9.7: <%= options['puppet_repo']['csr_attributes'] %>
    path: /etc/puppetlab/puppet/csr_attributes.yaml
    permissions: 0600
<% end %>
<% options['facts'].each do |fact, value| %>
  - content: |
      ---
      <%= fact %>: <%= value %>
    path: /opt/puppetlabs/facter/facts.d/<%= fact %>.yaml
    permissions: '0644'
<% end %>
      
<% if options['puppet_repo'] %>
runcmd:
  <% if options['puppet_repo']['package_manager'] == 'apt-get' %>
  - wget https://apt.puppetlabs.com/<%= options['puppet_repo']['repo_package'] %>
  - dpkg -i <%= options['puppet_repo']['repo_package'] %>
  <% elsif options['puppet_repo']['package_manager'] == 'yum' %>
  - rpm -ivh https://yum.puppetlabs.com/<%= options['puppet_repo']['repo_package'] %>
  - yum -y install puppet-agent
  <% end %>
  - /opt/puppetlabs/bin/puppet agent -t --waitforcert 5  --server <%= options['puppet_server'] %>
  - /opt/puppetlabs/bin/puppet agent -t
<% else %>
<% end %>
